<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>/Users/joshschramm/.rvm/gems/ruby-1.8.7-p249/gems/activesupport-3.0.0.beta4/lib/active_support/multibyte/unicode.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Eventcasts C0 Coverage Information - RCov</h1>
    <h2>/Users/joshschramm/.rvm/gems/ruby-1.8.7-p249/gems/activesupport-3.0.0.beta4/lib/active_support/multibyte/unicode.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="-Users-joshschramm-_rvm-gems-ruby-1_8_7-p249-gems-activesupport-3_0_0_beta4-lib-active_support-multibyte-unicode_rb.html">/Users/joshschramm/.rvm/gems/ruby-1.8.7-p249/gems/activesupport-3.0.0.beta4/lib/active_support/multibyte/unicode.rb</a></td>
            <td class='right_align'><tt>393</tt></td>
            <td class='right_align'><tt>287</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>38.93%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:39px"></div>
            <div class="uncovered" style="width:61px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>25.44%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:25px"></div>
            <div class="uncovered" style="width:75px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> module ActiveSupport</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a>   module Multibyte</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line3">3</a>     module Unicode</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line4">4</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line5">5</a>       extend self</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a>       # A list of all available normalization forms. See http://www.unicode.org/reports/tr15/tr15-29.html for more</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line8">8</a>       # information about normalization.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line9">9</a>       NORMALIZATION_FORMS = [:c, :kc, :d, :kd]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line10">10</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line11">11</a>       # The Unicode version that is supported by the implementation</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>       UNICODE_VERSION = '5.1.0'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line13">13</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line14">14</a>       # The default normalization used for operations that require normalization. It can be set to any of the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line15">15</a>       # normalizations in NORMALIZATION_FORMS.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line16">16</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a>       # Example:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line18">18</a>       #   ActiveSupport::Multibyte::Unicode.default_normalization_form = :c</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line19">19</a>       attr_accessor :default_normalization_form</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>       @default_normalization_form = :kc</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line21">21</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line22">22</a>       # Hangul character boundaries and properties</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a>       HANGUL_SBASE = 0xAC00</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line24">24</a>       HANGUL_LBASE = 0x1100</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line25">25</a>       HANGUL_VBASE = 0x1161</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line26">26</a>       HANGUL_TBASE = 0x11A7</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a>       HANGUL_LCOUNT = 19</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line28">28</a>       HANGUL_VCOUNT = 21</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line29">29</a>       HANGUL_TCOUNT = 28</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line30">30</a>       HANGUL_NCOUNT = HANGUL_VCOUNT * HANGUL_TCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line31">31</a>       HANGUL_SCOUNT = 11172</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line32">32</a>       HANGUL_SLAST = HANGUL_SBASE + HANGUL_SCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line33">33</a>       HANGUL_JAMO_FIRST = 0x1100</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line34">34</a>       HANGUL_JAMO_LAST = 0x11FF</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line35">35</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line36">36</a>       # All the unicode whitespace</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a>       WHITESPACE = [</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line38">38</a>         (0x0009..0x000D).to_a, # White_Space # Cc   [5] &lt;control-0009&gt;..&lt;control-000D&gt;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line39">39</a>         0x0020,                # White_Space # Zs       SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line40">40</a>         0x0085,                # White_Space # Cc       &lt;control-0085&gt;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line41">41</a>         0x00A0,                # White_Space # Zs       NO-BREAK SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a>         0x1680,                # White_Space # Zs       OGHAM SPACE MARK</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line43">43</a>         0x180E,                # White_Space # Zs       MONGOLIAN VOWEL SEPARATOR</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line44">44</a>         (0x2000..0x200A).to_a, # White_Space # Zs  [11] EN QUAD..HAIR SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line45">45</a>         0x2028,                # White_Space # Zl       LINE SEPARATOR</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line46">46</a>         0x2029,                # White_Space # Zp       PARAGRAPH SEPARATOR</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line47">47</a>         0x202F,                # White_Space # Zs       NARROW NO-BREAK SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a>         0x205F,                # White_Space # Zs       MEDIUM MATHEMATICAL SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line49">49</a>         0x3000,                # White_Space # Zs       IDEOGRAPHIC SPACE</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line50">50</a>       ].flatten.freeze</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line51">51</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line52">52</a>       # BOM (byte order mark) can also be seen as whitespace, it's a non-rendering character used to distinguish</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line53">53</a>       # between little and big endian. This is not an issue in utf-8, so it must be ignored.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line54">54</a>       LEADERS_AND_TRAILERS = WHITESPACE + [65279] # ZERO-WIDTH NO-BREAK SPACE aka BOM</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line55">55</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line56">56</a>       # Returns a regular expression pattern that matches the passed Unicode codepoints</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line57">57</a>       def self.codepoints_to_pattern(array_of_codepoints) #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>         array_of_codepoints.collect{ |e| [e].pack 'U*' }.join('|')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line59">59</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line60">60</a>       TRAILERS_PAT = /(#{codepoints_to_pattern(LEADERS_AND_TRAILERS)})+\Z/u</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line61">61</a>       LEADERS_PAT = /\A(#{codepoints_to_pattern(LEADERS_AND_TRAILERS)})+/u</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line63">63</a>       # Unpack the string at codepoints boundaries. Raises an EncodingError when the encoding of the string isn't</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line64">64</a>       # valid UTF-8.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line65">65</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line66">66</a>       # Example:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line67">67</a>       #   Unicode.u_unpack('Café') #=&gt; [67, 97, 102, 233]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line68">68</a>       def u_unpack(string)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line69">69</a>         begin</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line70">70</a>           string.unpack 'U*'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line71">71</a>         rescue ArgumentError</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line72">72</a>           raise EncodingError, 'malformed UTF-8 character'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line73">73</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line74">74</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line76">76</a>       # Detect whether the codepoint is in a certain character class. Returns +true+ when it's in the specified</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line77">77</a>       # character class and +false+ otherwise. Valid character classes are: &lt;tt&gt;:cr&lt;/tt&gt;, &lt;tt&gt;:lf&lt;/tt&gt;, &lt;tt&gt;:l&lt;/tt&gt;,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line78">78</a>       # &lt;tt&gt;:v&lt;/tt&gt;, &lt;tt&gt;:lv&lt;/tt&gt;, &lt;tt&gt;:lvt&lt;/tt&gt; and &lt;tt&gt;:t&lt;/tt&gt;.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line79">79</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line80">80</a>       # Primarily used by the grapheme cluster support.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line81">81</a>       def in_char_class?(codepoint, classes)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line82">82</a>         classes.detect { |c| database.boundary[c] === codepoint } ? true : false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line83">83</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line84">84</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line85">85</a>       # Unpack the string at grapheme boundaries. Returns a list of character lists.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line86">86</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a>       # Example:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a>       #   Unicode.g_unpack('क्षि') #=&gt; [[2325, 2381], [2359], [2367]]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line89">89</a>       #   Unicode.g_unpack('Café') #=&gt; [[67], [97], [102], [233]]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line90">90</a>       def g_unpack(string)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line91">91</a>         codepoints = u_unpack(string)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line92">92</a>         unpacked = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line93">93</a>         pos = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line94">94</a>         marker = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line95">95</a>         eoc = codepoints.length</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line96">96</a>         while(pos &lt; eoc)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line97">97</a>           pos += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line98">98</a>           previous = codepoints[pos-1]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line99">99</a>           current = codepoints[pos]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line100">100</a>           if (</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line101">101</a>               # CR X LF</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line102">102</a>               one = ( previous == database.boundary[:cr] and current == database.boundary[:lf] ) or</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line103">103</a>               # L X (L|V|LV|LVT)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line104">104</a>               two = ( database.boundary[:l] === previous and in_char_class?(current, [:l,:v,:lv,:lvt]) ) or</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line105">105</a>               # (LV|V) X (V|T)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line106">106</a>               three = ( in_char_class?(previous, [:lv,:v]) and in_char_class?(current, [:v,:t]) ) or</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line107">107</a>               # (LVT|T) X (T)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line108">108</a>               four = ( in_char_class?(previous, [:lvt,:t]) and database.boundary[:t] === current ) or</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line109">109</a>               # X Extend</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line110">110</a>               five = (database.boundary[:extend] === current)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line111">111</a>             )</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line112">112</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line113">113</a>             unpacked &lt;&lt; codepoints[marker..pos-1]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line114">114</a>             marker = pos</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line115">115</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line116">116</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line117">117</a>         unpacked</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line118">118</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line119">119</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line120">120</a>       # Reverse operation of g_unpack.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line121">121</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line122">122</a>       # Example:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line123">123</a>       #   Unicode.g_pack(Unicode.g_unpack('क्षि')) #=&gt; 'क्षि'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line124">124</a>       def g_pack(unpacked)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line125">125</a>         (unpacked.flatten).pack('U*')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line126">126</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line127">127</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a>       # Re-order codepoints so the string becomes canonical.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line129">129</a>       def reorder_characters(codepoints)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line130">130</a>         length = codepoints.length- 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line131">131</a>         pos = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line132">132</a>         while pos &lt; length do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line133">133</a>           cp1, cp2 = database.codepoints[codepoints[pos]], database.codepoints[codepoints[pos+1]]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line134">134</a>           if (cp1.combining_class &gt; cp2.combining_class) &amp;&amp; (cp2.combining_class &gt; 0)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line135">135</a>             codepoints[pos..pos+1] = cp2.code, cp1.code</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line136">136</a>             pos += (pos &gt; 0 ? -1 : 1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line137">137</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line138">138</a>             pos += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line139">139</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line140">140</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line141">141</a>         codepoints</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line142">142</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line143">143</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line144">144</a>       # Decompose composed characters to the decomposed form.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line145">145</a>       def decompose_codepoints(type, codepoints)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line146">146</a>         codepoints.inject([]) do |decomposed, cp|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line147">147</a>           # if it's a hangul syllable starter character</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line148">148</a>           if HANGUL_SBASE &lt;= cp and cp &lt; HANGUL_SLAST</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line149">149</a>             sindex = cp - HANGUL_SBASE</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line150">150</a>             ncp = [] # new codepoints</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line151">151</a>             ncp &lt;&lt; HANGUL_LBASE + sindex / HANGUL_NCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line152">152</a>             ncp &lt;&lt; HANGUL_VBASE + (sindex % HANGUL_NCOUNT) / HANGUL_TCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line153">153</a>             tindex = sindex % HANGUL_TCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line154">154</a>             ncp &lt;&lt; (HANGUL_TBASE + tindex) unless tindex == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line155">155</a>             decomposed.concat ncp</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line156">156</a>           # if the codepoint is decomposable in with the current decomposition type</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line157">157</a>           elsif (ncp = database.codepoints[cp].decomp_mapping) and (!database.codepoints[cp].decomp_type || type == :compatability)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line158">158</a>             decomposed.concat decompose_codepoints(type, ncp.dup)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line159">159</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line160">160</a>             decomposed &lt;&lt; cp</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line161">161</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line162">162</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line163">163</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line164">164</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line165">165</a>       # Compose decomposed characters to the composed form.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line166">166</a>       def compose_codepoints(codepoints)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line167">167</a>         pos = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line168">168</a>         eoa = codepoints.length - 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line169">169</a>         starter_pos = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line170">170</a>         starter_char = codepoints[0]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line171">171</a>         previous_combining_class = -1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line172">172</a>         while pos &lt; eoa</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line173">173</a>           pos += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line174">174</a>           lindex = starter_char - HANGUL_LBASE</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line175">175</a>           # -- Hangul</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line176">176</a>           if 0 &lt;= lindex and lindex &lt; HANGUL_LCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line177">177</a>             vindex = codepoints[starter_pos+1] - HANGUL_VBASE rescue vindex = -1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line178">178</a>             if 0 &lt;= vindex and vindex &lt; HANGUL_VCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line179">179</a>               tindex = codepoints[starter_pos+2] - HANGUL_TBASE rescue tindex = -1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line180">180</a>               if 0 &lt;= tindex and tindex &lt; HANGUL_TCOUNT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line181">181</a>                 j = starter_pos + 2</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line182">182</a>                 eoa -= 2</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line183">183</a>               else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line184">184</a>                 tindex = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line185">185</a>                 j = starter_pos + 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line186">186</a>                 eoa -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line187">187</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line188">188</a>               codepoints[starter_pos..j] = (lindex * HANGUL_VCOUNT + vindex) * HANGUL_TCOUNT + tindex + HANGUL_SBASE</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line189">189</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line190">190</a>             starter_pos += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line191">191</a>             starter_char = codepoints[starter_pos]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line192">192</a>           # -- Other characters</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line193">193</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line194">194</a>             current_char = codepoints[pos]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line195">195</a>             current = database.codepoints[current_char]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line196">196</a>             if current.combining_class &gt; previous_combining_class</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line197">197</a>               if ref = database.composition_map[starter_char]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line198">198</a>                 composition = ref[current_char]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line199">199</a>               else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line200">200</a>                 composition = nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line201">201</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line202">202</a>               unless composition.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line203">203</a>                 codepoints[starter_pos] = composition</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line204">204</a>                 starter_char = composition</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line205">205</a>                 codepoints.delete_at pos</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line206">206</a>                 eoa -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line207">207</a>                 pos -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line208">208</a>                 previous_combining_class = -1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line209">209</a>               else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line210">210</a>                 previous_combining_class = current.combining_class</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line211">211</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line212">212</a>             else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line213">213</a>               previous_combining_class = current.combining_class</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line214">214</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line215">215</a>             if current.combining_class == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line216">216</a>               starter_pos = pos</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line217">217</a>               starter_char = codepoints[pos]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line218">218</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line219">219</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line220">220</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line221">221</a>         codepoints</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line222">222</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line223">223</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line224">224</a>       # Replaces all ISO-8859-1 or CP1252 characters by their UTF-8 equivalent resulting in a valid UTF-8 string.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line225">225</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line226">226</a>       # Passing +true+ will forcibly tidy all bytes, assuming that the string's encoding is entirely CP1252 or ISO-8859-1.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line227">227</a>       def tidy_bytes(string, force = false)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line228">228</a>         if force</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line229">229</a>           return string.unpack(&quot;C*&quot;).map do |b|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line230">230</a>             tidy_byte(b)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line231">231</a>           end.flatten.compact.pack(&quot;C*&quot;).unpack(&quot;U*&quot;).pack(&quot;U*&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line232">232</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line233">233</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line234">234</a>         bytes = string.unpack(&quot;C*&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line235">235</a>         conts_expected = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line236">236</a>         last_lead = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line237">237</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line238">238</a>         bytes.each_index do |i|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line239">239</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line240">240</a>           byte          = bytes[i]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line241">241</a>           is_ascii      = byte &lt; 128</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line242">242</a>           is_cont       = byte &gt; 127 &amp;&amp; byte &lt; 192</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line243">243</a>           is_lead       = byte &gt; 191 &amp;&amp; byte &lt; 245</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line244">244</a>           is_unused     = byte &gt; 240</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line245">245</a>           is_restricted = byte &gt; 244</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line246">246</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line247">247</a>           # Impossible or highly unlikely byte? Clean it.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line248">248</a>           if is_unused || is_restricted</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line249">249</a>             bytes[i] = tidy_byte(byte)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line250">250</a>           elsif is_cont</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line251">251</a>             # Not expecting contination byte? Clean up. Otherwise, now expect one less.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line252">252</a>             conts_expected == 0 ? bytes[i] = tidy_byte(byte) : conts_expected -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line253">253</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line254">254</a>             if conts_expected &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line255">255</a>               # Expected continuation, but got ASCII or leading? Clean backwards up to</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line256">256</a>               # the leading byte.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line257">257</a>               (1..(i - last_lead)).each {|j| bytes[i - j] = tidy_byte(bytes[i - j])}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line258">258</a>               conts_expected = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line259">259</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line260">260</a>             if is_lead</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line261">261</a>               # Final byte is leading? Clean it.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line262">262</a>               if i == bytes.length - 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line263">263</a>                 bytes[i] = tidy_byte(bytes.last)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line264">264</a>               else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line265">265</a>                 # Valid leading byte? Expect continuations determined by position of</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line266">266</a>                 # first zero bit, with max of 3.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line267">267</a>                 conts_expected = byte &lt; 224 ? 1 : byte &lt; 240 ? 2 : 3</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line268">268</a>                 last_lead = i</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line269">269</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line270">270</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line271">271</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line272">272</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line273">273</a>         bytes.empty? ? &quot;&quot; : bytes.flatten.compact.pack(&quot;C*&quot;).unpack(&quot;U*&quot;).pack(&quot;U*&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line274">274</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line275">275</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line276">276</a>       # Returns the KC normalization of the string by default. NFKC is considered the best normalization form for</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line277">277</a>       # passing strings to databases and validations.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line278">278</a>       #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line279">279</a>       # * &lt;tt&gt;string&lt;/tt&gt; - The string to perform normalization on.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line280">280</a>       # * &lt;tt&gt;form&lt;/tt&gt; - The form you want to normalize in. Should be one of the following:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line281">281</a>       #   &lt;tt&gt;:c&lt;/tt&gt;, &lt;tt&gt;:kc&lt;/tt&gt;, &lt;tt&gt;:d&lt;/tt&gt;, or &lt;tt&gt;:kd&lt;/tt&gt;. Default is</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a>       #   ActiveSupport::Multibyte.default_normalization_form</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line283">283</a>       def normalize(string, form=nil)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line284">284</a>         form ||= @default_normalization_form</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line285">285</a>         # See http://www.unicode.org/reports/tr15, Table 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line286">286</a>         codepoints = u_unpack(string)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line287">287</a>         case form</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line288">288</a>           when :d</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line289">289</a>             reorder_characters(decompose_codepoints(:canonical, codepoints))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line290">290</a>           when :c</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line291">291</a>             compose_codepoints(reorder_characters(decompose_codepoints(:canonical, codepoints)))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line292">292</a>           when :kd</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line293">293</a>             reorder_characters(decompose_codepoints(:compatability, codepoints))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line294">294</a>           when :kc</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line295">295</a>             compose_codepoints(reorder_characters(decompose_codepoints(:compatability, codepoints)))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line296">296</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line297">297</a>             raise ArgumentError, &quot;#{form} is not a valid normalization variant&quot;, caller</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line298">298</a>         end.pack('U*')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line299">299</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line300">300</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line301">301</a>       def apply_mapping(string, mapping) #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line302">302</a>         u_unpack(string).map do |codepoint|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line303">303</a>           cp = database.codepoints[codepoint]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line304">304</a>           if cp and (ncp = cp.send(mapping)) and ncp &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line305">305</a>             ncp</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line306">306</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line307">307</a>             codepoint</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line308">308</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line309">309</a>         end.pack('U*')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line310">310</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line311">311</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line312">312</a>       # Holds data about a codepoint in the Unicode database</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line313">313</a>       class Codepoint</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line314">314</a>         attr_accessor :code, :combining_class, :decomp_type, :decomp_mapping, :uppercase_mapping, :lowercase_mapping</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line315">315</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line316">316</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line317">317</a>       # Holds static data from the Unicode database</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line318">318</a>       class UnicodeDatabase</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line319">319</a>         ATTRIBUTES = :codepoints, :composition_exclusion, :composition_map, :boundary, :cp1252</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line320">320</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line321">321</a>         attr_writer(*ATTRIBUTES)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line322">322</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>         def initialize</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line324">324</a>           @codepoints = Hash.new(Codepoint.new)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line325">325</a>           @composition_exclusion = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line326">326</a>           @composition_map = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line327">327</a>           @boundary = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line328">328</a>           @cp1252 = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line329">329</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line330">330</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line331">331</a>         # Lazy load the Unicode database so it's only loaded when it's actually used</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line332">332</a>         ATTRIBUTES.each do |attr_name|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line333">333</a>           class_eval(&lt;&lt;-EOS, __FILE__, __LINE__ + 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line334">334</a>             def #{attr_name}     # def codepoints</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line335">335</a>               load               #   load</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line336">336</a>               @#{attr_name}      #   @codepoints</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line337">337</a>             end                  # end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line338">338</a>           EOS</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line339">339</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line340">340</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line341">341</a>         # Loads the Unicode database and returns all the internal objects of UnicodeDatabase.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line342">342</a>         def load</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line343">343</a>           begin</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line344">344</a>             @codepoints, @composition_exclusion, @composition_map, @boundary, @cp1252 = File.open(self.class.filename, 'rb') { |f| Marshal.load f.read }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line345">345</a>           rescue Exception =&gt; e</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line346">346</a>               raise IOError.new(&quot;Couldn't load the Unicode tables for UTF8Handler (#{e.message}), ActiveSupport::Multibyte is unusable&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line347">347</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line348">348</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line349">349</a>           # Redefine the === method so we can write shorter rules for grapheme cluster breaks</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line350">350</a>           @boundary.each do |k,_|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line351">351</a>             @boundary[k].instance_eval do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line352">352</a>               def ===(other)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line353">353</a>                 detect { |i| i === other } ? true : false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line354">354</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line355">355</a>             end if @boundary[k].kind_of?(Array)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line356">356</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line357">357</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line358">358</a>           # define attr_reader methods for the instance variables</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line359">359</a>           class &lt;&lt; self</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line360">360</a>             attr_reader(*ATTRIBUTES)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line361">361</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line362">362</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line363">363</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line364">364</a>         # Returns the directory in which the data files are stored</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line365">365</a>         def self.dirname</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line366">366</a>           File.dirname(__FILE__) + '/../values/'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line367">367</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line368">368</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line369">369</a>         # Returns the filename for the data file for this version</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line370">370</a>         def self.filename</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line371">371</a>           File.expand_path File.join(dirname, &quot;unicode_tables.dat&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line372">372</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line373">373</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line374">374</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line375">375</a>       private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line376">376</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line377">377</a>       def tidy_byte(byte)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line378">378</a>         if byte &lt; 160</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line379">379</a>           [database.cp1252[byte] || byte].pack(&quot;U&quot;).unpack(&quot;C*&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line380">380</a>         elsif byte &lt; 192</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line381">381</a>           [194, byte]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line382">382</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line383">383</a>           [195, byte - 64]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line384">384</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line385">385</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line386">386</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line387">387</a>       def database</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line388">388</a>         @database ||= UnicodeDatabase.new</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line389">389</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line390">390</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line391">391</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line392">392</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line393">393</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Sun Jun 20 15:17:49 -0400 2010 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>
